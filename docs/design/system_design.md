# システム設計書

## 1. システム概要
請求書出力アプリは、販売員の納品書を管理し、月次で請求書を自動生成する業務システムです。委託先の請求書も独立して管理します。手書き納品書の画像から自動的にデータを抽出するAI機能を搭載しています。

## 2. アーキテクチャ
システムは以下のアーキテクチャを採用します：

- **フロントエンド**: Next.js 14 (App Router) を使用したSPA/SSRハイブリッドアプリケーション
- **バックエンド**: FastAPI を使用したREST APIサーバー
- **データベース**: PostgreSQL を使用したRDBMS
- **外部サービス**: Google Gemini API (画像認識), Google Drive API (ファイルストレージ)

### アーキテクチャ図
```
┌─────────────────────────────────────┐
│         Next.js Frontend            │
│  (Vercel - SSR/CSR Hybrid)         │
│  - モバイルファーストUI             │
│  - リアルタイム更新                 │
│  - 画像プレビュー・編集             │
└──────────────┬──────────────────────┘
               │ REST API
               │ (JSON)
┌──────────────▼──────────────────────┐
│         FastAPI Backend             │
│  (Fly.io - 非同期処理)             │
│  - ビジネスロジック                 │
│  - Gemini API連携                   │
│  - Google Drive連携                 │
└──────────────┬──────────────────────┘
               │
    ┌──────────┴──────────┐
    │                     │
┌───▼──────┐      ┌──────▼─────────┐
│PostgreSQL│      │ External APIs  │
│(Supabase)│      │ - Gemini API   │
│          │      │ - Drive API    │
└──────────┘      └────────────────┘
```

## 3. 技術スタック詳細

### フロントエンド
- **フレームワーク**: Next.js 14 (App Router)
- **言語**: TypeScript 5.x
- **スタイリング**: Tailwind CSS 3.x
- **UIコンポーネント**: shadcn/ui
- **状態管理**: TanStack Query (React Query) v5
- **フォーム管理**: React Hook Form + Zod
- **日付処理**: date-fns
- **アイコン**: Lucide React
- **画像処理**: react-dropzone, react-image-crop

### バックエンド
- **フレームワーク**: FastAPI 0.104+
- **言語**: Python 3.11+
- **ORM**: SQLAlchemy 2.0
- **マイグレーション**: Alembic
- **バリデーション**: Pydantic v2
- **認証**: JWT (python-jose)
- **非同期処理**: asyncio, httpx

### データベース
- **RDBMS**: PostgreSQL 15

### 外部API・サービス
- **AI/OCR**: Google Gemini API (gemini-1.5-flash)
- **ファイルストレージ**: Google Drive API
- **PDF生成**: ReportLab (Python)

## 4. コンポーネント設計

### フロントエンドコンポーネント
- **認証コンポーネント**: ログイン/ログアウト処理
- **ダッシュボードコンポーネント**: KPI表示、グラフ
- **納品書管理コンポーネント**: 一覧、アップロード、編集
- **請求書管理コンポーネント**: 生成、PDF出力
- **マスタ管理コンポーネント**: CRUD操作

### バックエンドコンポーネント
- **認証モジュール**: JWTトークン管理
- **マスタ管理モジュール**: CRUD API
- **納品書管理モジュール**: 画像認識、データ処理
- **請求書生成モジュール**: 集計、PDF生成
- **外部API連携モジュール**: Gemini API, Google Drive API

## 5. データフロー
1. ユーザーが納品書画像をアップロード
2. フロントエンドが画像をバックエンドに送信
3. バックエンドがGemini APIで画像を解析
4. 解析結果をデータベースに保存
5. ユーザーが結果を確認・編集
6. 月次で請求書を自動生成
7. PDFを生成し、Google Driveに保存

## 6. セキュリティ設計
- HTTPS通信必須
- JWT認証
- CORS設定
- XSS/CSRF対策
- SQLインジェクション対策（ORM使用）
- 機密情報の環境変数管理

## 7. パフォーマンス設計
- ページ読み込み: 2秒以内
- API応答時間: 500ms以内
- 画像認識処理: 5-10秒以内
- 同時接続: 10ユーザー対応